#!/usr/bin/env bash
set -euo pipefail

repo_root=$(git rev-parse --show-toplevel)
cd "$repo_root"

if [[ -n "${SKIP_PREFLIGHT:-}" ]]; then
  echo "[pre-commit] SKIP_PREFLIGHT set; skipping checks."
  exit 0
fi

staged_files="$(git diff --cached --name-only)"
if [[ -z "$staged_files" ]]; then
  exit 0
fi

has_rust=0
has_gui=0
has_lock_change=0

while IFS= read -r f; do
  case "$f" in
    *.rs|Cargo.toml|Cargo.lock|rust-toolchain.toml|rust-toolchain)
      has_rust=1
      ;;
    apps/gui/*)
      has_gui=1
      ;;
  esac

  case "$f" in
    apps/gui/package-lock.json|apps/gui/package.json)
      has_lock_change=1
      ;;
  esac
done <<<"$staged_files"

if [[ "$has_rust" -eq 1 ]]; then
  echo "[pre-commit] Rust: cargo fmt --check"
  cargo fmt --check

  # Keep this hook opinionated: CI runs clippy with -D warnings, so we do too.
  echo "[pre-commit] Rust: cargo clippy --workspace --exclude agentmesh-app -- -D warnings"
  cargo clippy --workspace --exclude agentmesh-app -- -D warnings
fi

if [[ "$has_gui" -eq 1 ]]; then
  if [[ -n "${SKIP_GUI_PREFLIGHT:-}" ]]; then
    echo "[pre-commit] SKIP_GUI_PREFLIGHT set; skipping GUI checks."
    exit 0
  fi

  if [[ "$has_lock_change" -eq 1 ]] || [[ ! -d "apps/gui/node_modules" ]]; then
    echo "[pre-commit] GUI: npm ci (lockfile change or missing node_modules)"
    (cd apps/gui && npm ci)
  fi

  echo "[pre-commit] GUI: npm run build"
  (cd apps/gui && npm run build)
fi

exit 0

