{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://agentmesh.dev/schemas/orchestrator-actions.schema.json",
  "title": "AgentMesh Orchestrator Actions",
  "description": "Orchestrator（模型）输出的结构化 actions，供 Controller（程序状态机）解析并确定性执行。",
  "type": "object",
  "required": ["sessionGoal", "tasks"],
  "properties": {
    "sessionGoal": {
      "type": "string",
      "minLength": 1,
      "maxLength": 4000,
      "description": "本次主控会话的高层目标（用于 StateBoard 的首行锚点）。"
    },
    "tasks": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/definitions/subtask" },
      "description": "本轮需要由 Controller 派发/监控/收敛的 subtasks。"
    }
  },
  "definitions": {
    "subtask": {
      "type": "object",
      "required": ["taskId", "title", "agent", "adapter", "prompt"],
      "properties": {
        "taskId": {
          "type": "string",
          "pattern": "^[A-Za-z0-9_-]+$",
          "description": "subtask id（在同一 actions 中唯一）。默认也可作为 agentInstance 使用。"
        },
        "agentInstance": {
          "type": "string",
          "pattern": "^[A-Za-z0-9_-]+$",
          "description": "可选：显式指定 agent instance id（覆盖 taskId）。"
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200,
          "description": "子任务标题（用于 StateBoard/报告展示）。"
        },
        "agent": {
          "type": "string",
          "pattern": "^[A-Za-z0-9_-]+$",
          "description": "agent 名称（对应 roster[].agent）。"
        },
        "adapter": {
          "type": "string",
          "enum": ["codex-exec", "codex-app-server"],
          "description": "执行路径：codex-exec（一次性 worker）或 codex-app-server（thread/turn 模型）。"
        },
        "mode": {
          "type": "string",
          "enum": ["spawn", "fork"],
          "default": "spawn",
          "description": "派生策略：spawn（最小上下文）或 fork（继承上下文）。"
        },
        "forkedFromThreadId": {
          "type": "string",
          "description": "当 mode=fork 时必填：父 thread id。"
        },
        "cwd": {
          "type": "string",
          "description": "可选：覆盖执行工作目录。默认由 Controller 使用 workspace root。"
        },
        "prompt": {
          "type": "string",
          "minLength": 1,
          "maxLength": 40000,
          "description": "传给 subagent 的任务指令。"
        },
        "outputSchemaPath": {
          "type": "string",
          "description": "可选：输出 JSON schema 路径（默认 ./schemas/worker-output.schema.json）。仅对 codex-exec 生效。"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "mode": { "const": "fork" } },
            "required": ["mode"]
          },
          "then": {
            "required": ["forkedFromThreadId"]
          }
        }
      ],
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}

